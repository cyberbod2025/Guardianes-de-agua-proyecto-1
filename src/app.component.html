<div class="min-h-screen p-4 sm:p-8 flex flex-col items-center justify-center font-sans text-gray-800">

  <header class="text-center mb-6">
    <h1 class="text-5xl md:text-6xl font-black uppercase bg-gradient-to-r from-amber-400 via-yellow-200 to-amber-500 bg-clip-text text-transparent">
      Guardianes del Agua
    </h1>
  </header>

  <!-- Progress Map -->
  @if (currentModule() > 0) {
    <nav class="w-full max-w-4xl mb-8">
      <ul class="flex justify-between items-center">
        @for (module of ['Problema', 'Plan', 'Hipótesis', 'Experimento', 'Análisis', 'Reporte']; track module; let i = $index) {
          <li class="flex-1 text-center">
            <button (click)="goToModule(i + 1)" [disabled]="i + 1 > currentModule()" class="flex flex-col sm:flex-row items-center justify-center w-full group">
              <span class="flex items-center justify-center w-10 h-10 rounded-full border-2 transition-all duration-300"
                    [class.bg-blue-600]="currentModule() > i + 1"
                    [class.border-blue-600]="currentModule() > i"
                    [class.text-white]="currentModule() > i + 1"
                    [class.bg-blue-500]="currentModule() === i + 1"
                    [class.text-white]="currentModule() === i + 1"
                    [class.border-gray-400]="currentModule() <= i"
                    [class.text-gray-500]="currentModule() <= i"
                    [class.group-hover:border-blue-500]="i + 1 <= currentModule()"
                    [class.group-hover:text-blue-500]="i + 1 === currentModule()"
                    >
                {{ i + 1 }}
              </span>
              <span class="text-xs sm:text-sm mt-1 sm:mt-0 sm:ml-2 font-semibold transition-colors duration-300"
                    [class.text-blue-700]="currentModule() >= i + 1"
                    [class.text-gray-500]="currentModule() < i + 1"
                    [class.group-hover:text-blue-600]="i + 1 <= currentModule()"
                    >{{ module }}</span>
            </button>
          </li>
          @if (!$last) {
            <li class="flex-1 h-px bg-gray-300 hidden sm:block mx-2"></li>
          }
        }
      </ul>
    </nav>
  }

  <main class="w-full max-w-4xl bg-white/70 backdrop-blur-sm rounded-2xl shadow-lg p-6 sm:p-10 relative">
    @switch (currentModule()) {
      @case (0) {
        <!-- Intro Screen -->
        <div class="text-center fade-in">
          <h2 class="text-3xl font-bold text-blue-800 mb-4">¡Bienvenido a la Misión!</h2>
          <p class="text-lg text-gray-700 mb-8">Tu comunidad te necesita. Prepárate para investigar, experimentar y proponer soluciones a los problemas del agua. ¿Estás listo para convertirte en un Guardián del Agua?</p>
          <button (click)="goToModule(1)" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-transform duration-200 hover:scale-105 text-xl">
            ¡Comenzar Misión!
          </button>
        </div>
      }
      @case (1) {
        <!-- Module 1: Define Problem -->
        <div class="fade-in">
          <h2 class="text-2xl font-bold text-blue-800 mb-1">Módulo 1: El Problema</h2>
          <p class="text-gray-600 mb-6">El primer paso es hacer una pregunta que podamos MEDIR. ¡Piensa en números, cantidades o tiempo!</p>
          <div class="space-y-4">
            <label for="question-input" class="block text-lg font-medium text-gray-700">Formula tu pregunta de investigación:</label>
            <textarea id="question-input" [value]="question()" (input)="onQuestionInput($event)" rows="4" class="w-full p-3 bg-black text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder:text-gray-400" placeholder="Ej: ¿Cuántos litros de agua de lluvia puede recolectar un techo de 50m² en una hora?"></textarea>
            <button (click)="validateQuestion()" [disabled]="isLoading() || !question().trim()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors duration-300 flex items-center justify-center text-lg">
              @if (isLoading()) {
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>Validando con el Guardián...</span>
              } @else {
                <span>¡Validar Pregunta!</span>
              }
            </button>
          </div>
          @if (validationResponse(); as response) {
            <div class="mt-6 p-4 rounded-lg border text-center" [class.bg-green-100]="response.is_measurable" [class.text-green-800]="response.is_measurable" [class.border-green-400]="response.is_measurable" [class.bg-yellow-100]="!response.is_measurable" [class.text-yellow-800]="!response.is_measurable" [class.border-yellow-400]="!response.is_measurable">
              <p class="font-semibold">{{ response.feedback }}</p>
              @if(response.is_measurable) { <p class="text-sm">¡Excelente! Preparando el siguiente módulo...</p> }
            </div>
          }
        </div>
      }
      @case (2) {
        <!-- Module 2: Plan de Ataque -->
        <div class="fade-in">
          <h2 class="text-2xl font-bold text-blue-800 mb-1">Módulo 2: Plan de Ataque</h2>
          <p class="text-gray-600 mb-6">¿Qué pasos seguirán para responder su pregunta? Anoten todas las tareas, ¡ninguna es demasiado pequeña!</p>
          <div class="flex gap-2 mb-4">
            <input type="text" [(ngModel)]="newTask" (keyup.enter)="addTask()" placeholder="Ej: Investigar tipos de filtros de agua" class="flex-grow p-3 bg-black text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder:text-gray-400">
            <button (click)="addTask()" class="bg-blue-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors" [disabled]="!newTask().trim()">Añadir</button>
          </div>
          <ul class="space-y-2">
            @for (task of actionPlanTasks(); track task.id) {
              <li class="flex items-center justify-between bg-gray-100 p-3 rounded-lg">
                <span class="text-gray-800">{{ task.text }}</span>
                <button (click)="removeTask(task.id)" class="text-red-500 hover:text-red-700 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
              </li>
            } @empty {
              <li class="text-center text-gray-500 p-4">Aún no hay tareas en el plan.</li>
            }
          </ul>
           <div class="flex justify-end mt-6">
            <button (click)="goToModule(3)" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Siguiente</button>
          </div>
        </div>
      }
      @case (3) {
        <!-- Module 3: Hypothesis -->
        <div class="fade-in">
          <h2 class="text-2xl font-bold text-blue-800 mb-1">Módulo 3: La Hipótesis</h2>
          <p class="text-gray-600 mb-6">Una hipótesis es su mejor suposición. ¿Qué creen que descubrirán? ¡Escriban su predicción!</p>
          <textarea [value]="hypothesis()" (input)="onHypothesisInput($event)" rows="6" class="w-full p-3 bg-black text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder:text-gray-400" placeholder="Ej: Creemos que podremos recolectar 20 litros de agua purificada con nuestro sistema..."></textarea>
          <div class="flex justify-between mt-6">
            <button (click)="goToModule(2)" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Atrás</button>
            <button (click)="goToModule(4)" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Siguiente</button>
          </div>
        </div>
      }
      @case (4) {
        <!-- Module 4: Experiment -->
        <div class="fade-in">
          <h2 class="text-2xl font-bold text-blue-800 mb-1">Módulo 4: ¡A Experimentar!</h2>
          <p class="text-gray-600 mb-6">¡Manos a la obra! Sigan su plan, realicen sus mediciones y anoten los resultados aquí. La gráfica se actualizará sola.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-bold text-lg mb-2">Registrar Datos</h3>
              <div class="flex gap-2 mb-4">
                <input type="text" [(ngModel)]="newExperimentLabel" placeholder="Etiqueta (Ej: Prueba 1)" class="w-2/3 p-2 bg-black text-white rounded-lg focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400">
                <input type="number" [(ngModel)]="newExperimentValue" placeholder="Valor" class="w-1/3 p-2 bg-black text-white rounded-lg focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400">
                <button (click)="addExperimentDataPoint()" class="bg-blue-600 text-white font-bold p-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400" [disabled]="!newExperimentLabel().trim() || newExperimentValue() === null">Añadir</button>
              </div>
              <ul class="space-y-2 max-h-48 overflow-y-auto">
                @for (data of experimentData(); track data.id) {
                <li class="flex items-center justify-between bg-gray-100 p-2 rounded-lg">
                  <span class="text-gray-800 font-medium">{{ data.label }}:</span>
                  <span class="text-gray-800">{{ data.value }}</span>
                   <button (click)="removeExperimentDataPoint(data.id)" class="text-red-500 hover:text-red-700 transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </li>
                } @empty {
                  <li class="text-center text-gray-500 p-4">Sin datos registrados.</li>
                }
              </ul>
            </div>
            <div>
              <h3 class="font-bold text-lg mb-2">Visualización de Resultados</h3>
              <div #chartContainer class="w-full h-[300px] bg-gray-50 rounded-lg p-2">
                @if(experimentData().length === 0) {
                  <div class="flex items-center justify-center h-full text-gray-500">La gráfica aparecerá aquí.</div>
                }
              </div>
            </div>
          </div>
          <div class="flex justify-between mt-6">
            <button (click)="goToModule(3)" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Atrás</button>
            <button (click)="goToModule(5)" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Siguiente</button>
          </div>
        </div>
      }
      @case (5) {
        <!-- Module 5: Analysis and Conclusion -->
        <div class="fade-in">
          <h2 class="text-2xl font-bold text-blue-800 mb-1">Módulo 5: Análisis y Conclusión</h2>
          <p class="text-gray-600 mb-6">¡Es hora de pensar! ¿Qué significan sus datos? ¿Su hipótesis fue correcta? ¿Qué aprendieron?</p>
          <div class="space-y-4">
            <div>
              <label class="block text-lg font-medium text-gray-700 mb-2">Análisis de Resultados:</label>
              <textarea [value]="analysis()" (input)="onAnalysisInput($event)" rows="5" class="w-full p-3 bg-black text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder:text-gray-400" placeholder="Describe lo que observas en los datos y la gráfica. ¿Hubo sorpresas?"></textarea>
            </div>
            <div>
              <label class="block text-lg font-medium text-gray-700 mb-2">Conclusión de la Misión:</label>
              <textarea [value]="conclusion()" (input)="onConclusionInput($event)" rows="5" class="w-full p-3 bg-black text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder:text-gray-400" placeholder="¿Se cumplió la hipótesis? ¿Qué harían diferente la próxima vez? ¿Cuál es la solución que proponen?"></textarea>
            </div>
          </div>
          <div class="flex justify-between mt-6">
            <button (click)="goToModule(4)" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Atrás</button>
            <button (click)="goToModule(6)" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Finalizar Misión</button>
          </div>
        </div>
      }
       @case (6) {
        <!-- Final Screen -->
        <div class="text-center fade-in">
          <h2 class="text-3xl font-bold text-green-600 mb-4">¡Misión Cumplida, Guardianes!</h2>
          <p class="text-lg text-gray-700 mb-8">Han completado todos los módulos de la misión. Su trabajo ayudará a proteger el agua de su comunidad. ¡Estamos orgullosos de ustedes!</p>
          <button (click)="generateReport()" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-transform duration-200 hover:scale-105 text-xl">
            Generar Reporte Final
          </button>
        </div>
      }
    }
  </main>
  
  <!-- Undo Notification -->
  @if (showUndo()) {
    <div class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-4 fade-in">
      <span>Tarea eliminada.</span>
      <button (click)="undoRemoveTask()" class="font-bold hover:underline">Deshacer</button>
    </div>
  }
</div>
